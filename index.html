<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voice Message Upload</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W2kKI3M8zgGHYhfTxP8NE+Zzn+3N28sghghWn4KzJ0mAL1DyYx1V3FMohtscv9POzhxg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    label, input, button {
      display: block;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.2em;
    }
    #recordBtn {
      background-color: #28a745;
      color: white;
    }
    #stopBtn {
      background-color: #dc3545;
      color: white;
    }
    #submitBtn {
      background-color: #007bff;
      color: white;
    }
    .hidden {
      display: none;
    }
    #waveform {
      width: 100%;
      height: 100px;
      background-color: #f1f1f1;
      margin: 10px 0;
    }
    #recordingIndicator {
      font-weight: bold;
      color: red;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>Send a Voice Message</h1>

  <form id="voiceForm">
    <label>
      <input type="checkbox" id="anonymousCheckbox" /> Submit Anonymously
    </label>

    <div id="userDetails">
      <label>Name (optional):</label>
      <input type="text" name="name" id="name" />

      <label>Email (optional):</label>
      <input type="email" name="email" id="email" />
    </div>

    <button type="button" id="recordBtn"><i class="fa-solid fa-microphone"></i> Start</button>
    <button type="button" id="stopBtn" class="hidden"><i class="fa-solid fa-stop"></i> Stop</button>
    <div id="recordingIndicator" class="hidden">‚óè Recording...</div>

    <div id="waveform"></div>

    <audio id="audioPlayback" controls class="hidden"></audio>
    <button type="submit" id="submitBtn" class="hidden"><i class="fa-solid fa-paper-plane"></i> Submit</button>
  </form>

  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script>
    let mediaRecorder;
    let audioChunks = [];
    let stream;
    let liveStream;
    let microphone;

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const submitBtn = document.getElementById("submitBtn");
    const audioPlayback = document.getElementById("audioPlayback");
    const voiceForm = document.getElementById("voiceForm");
    const anonymousCheckbox = document.getElementById("anonymousCheckbox");
    const userDetails = document.getElementById("userDetails");
    const recordingIndicator = document.getElementById("recordingIndicator");

    const wavesurfer = WaveSurfer.create({
      container: '#waveform',
      waveColor: '#ccc',
      progressColor: '#007bff',
      height: 100,
    });

    anonymousCheckbox.addEventListener("change", () => {
      userDetails.style.display = anonymousCheckbox.checked ? "none" : "block";
    });

    recordBtn.onclick = async () => {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      wavesurfer.empty();
      if (microphone) microphone.destroy();
      microphone = wavesurfer.microphone = Object.create(WaveSurfer.Microphone);
      microphone.init({ wavesurfer: wavesurfer }).start();

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        audioPlayback.src = url;
        audioPlayback.classList.remove('hidden');
        submitBtn.classList.remove('hidden');
        recordBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
        recordingIndicator.classList.add('hidden');

        if (microphone) microphone.stop();
        wavesurfer.load(url);
      };

      mediaRecorder.start();
      recordBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');
      recordingIndicator.classList.remove('hidden');

      setTimeout(() => {
        if (mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
      }, 5 * 60 * 1000);
    };

    stopBtn.onclick = () => {
      if (mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
    };

    voiceForm.onsubmit = async e => {
      e.preventDefault();

      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append("audio", blob, `voice-${Date.now()}.webm`);

      if (!anonymousCheckbox.checked) {
        formData.append("name", document.getElementById("name").value);
        formData.append("email", document.getElementById("email").value);
      }

      const response = await fetch("/upload.php", {
        method: "POST",
        body: formData
      });

      if (response.ok) {
        alert("Voice message submitted successfully.");
        voiceForm.reset();
        audioPlayback.classList.add('hidden');
        submitBtn.classList.add('hidden');
        wavesurfer.empty();
      } else {
        alert("Failed to submit voice message.");
      }
    };
  </script>
  <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.microphone.min.js"></script>
</body>
</html>
